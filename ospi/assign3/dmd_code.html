    <pre>
<span class="comment">(* Performs a diamond trunction with truncation index k and dimension
   dims... returns a int list list of the indices *)</span>
<span class="tuareg-font-lock-governing">let</span> <span class="function-name">diamond_truncation</span><span class="variable-name"> k dims </span><span class="tuareg-font-lock-operator">:</span> <span class="type">int list list </span><span class="tuareg-font-lock-operator">=</span>
  <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">dmd_aux</span><span class="variable-name"> dim last </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">match</span> dim <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">|</span> d <span class="keyword">when</span> d <span class="tuareg-font-lock-operator">=</span> dims <span class="tuareg-font-lock-operator">-&gt;</span> <span class="comment">(* last dimension... non-recursive base case *)</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">start </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> last <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> 0 <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> pos </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">(</span>pos <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>abs last<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">&gt;</span> k <span class="keyword">then</span> <span class="tuareg-font-lock-operator">[]</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">[</span>pos<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">::</span> <span class="tuareg-font-lock-operator">(</span>aux <span class="tuareg-font-lock-operator">(</span>pos <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
          aux start
      <span class="tuareg-font-lock-operator">|</span> d <span class="keyword">when</span> d <span class="tuareg-font-lock-operator">&lt;</span> dims <span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">result </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">-(</span>k<span class="tuareg-font-lock-operator">-</span>last<span class="tuareg-font-lock-operator">)</span> <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span>k<span class="tuareg-font-lock-operator">-</span>last<span class="tuareg-font-lock-operator">)</span> <span class="keyword">do</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ith </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">r </span><span class="tuareg-font-lock-operator">-&gt;</span> i <span class="tuareg-font-lock-operator">::</span> r<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>dmd_aux <span class="tuareg-font-lock-operator">(</span>d<span class="tuareg-font-lock-operator">+</span>1<span class="tuareg-font-lock-operator">)</span> i<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
            result <span class="tuareg-font-lock-operator">:=</span> <span class="type">List</span>.append ith <span class="tuareg-font-lock-operator">!</span>result
          <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
          <span class="tuareg-font-lock-operator">!</span>result
      <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">failwith</span> <span class="string">"this is very very bad"</span>
  <span class="tuareg-font-lock-governing">in</span>
  <span class="type">List</span>.sort <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.map <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">x </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">List</span>.rev x<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>dmd_aux 1 0<span class="tuareg-font-lock-operator">))</span></pre>

