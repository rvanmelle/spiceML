    <pre>
<span class="comment">(* Performs a box trunction using the box truncation indices defined
   by ks... returns a int list list of the indices *)</span>
<span class="tuareg-font-lock-governing">let</span> <span class="function-name">box_truncation</span><span class="variable-name"> ks </span><span class="tuareg-font-lock-operator">:</span> <span class="type">int list list </span><span class="tuareg-font-lock-operator">=</span>
  <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">box_aux</span><span class="variable-name"> ks last </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">start</span><span class="variable-name"> cur </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> last <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">then</span> 0 <span class="keyword">else</span> <span class="tuareg-font-lock-operator">-</span>cur <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">match</span> ks <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">|</span> kcur <span class="tuareg-font-lock-operator">::</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="comment">(* last index... non-recursive base case *)</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> pos </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">if</span> pos <span class="tuareg-font-lock-operator">&gt;</span> kcur <span class="keyword">then</span> <span class="tuareg-font-lock-operator">[]</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">[</span>pos<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">::</span> <span class="tuareg-font-lock-operator">(</span>aux <span class="tuareg-font-lock-operator">(</span>pos <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
          aux <span class="tuareg-font-lock-operator">(</span>start kcur<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">|</span> kcur <span class="tuareg-font-lock-operator">::</span> rest <span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">result </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>start kcur<span class="tuareg-font-lock-operator">)</span> <span class="keyword">to</span> kcur <span class="keyword">do</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ith </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">r </span><span class="tuareg-font-lock-operator">-&gt;</span> i <span class="tuareg-font-lock-operator">::</span> r<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>box_aux rest i<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
            result <span class="tuareg-font-lock-operator">:=</span> <span class="type">List</span>.append ith <span class="tuareg-font-lock-operator">!</span>result
          <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
          <span class="tuareg-font-lock-operator">!</span>result
      <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">failwith</span> <span class="string">"this should not happen"</span>
  <span class="tuareg-font-lock-governing">in</span>
  <span class="type">List</span>.sort <span class="tuareg-font-lock-operator">(</span>box_aux ks 0<span class="tuareg-font-lock-operator">)</span></pre>

