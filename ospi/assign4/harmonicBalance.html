    <pre>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Printf</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Solver</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Recorder</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Complex</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Gsl_helpers</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">ExtList</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Util.ListHelpers</span>

<span class="tuareg-font-lock-governing">let</span> <span class="variable-name">debug </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Circuit</span>.debug
<span class="tuareg-font-lock-governing">let</span> <span class="variable-name">info </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Circuit</span>.info
<span class="tuareg-font-lock-governing">let</span> <span class="variable-name">warn </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Circuit</span>.warn

<span class="tuareg-font-lock-governing">module</span> <span class="type">HB </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-governing">functor</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">Solver</span><span class="tuareg-font-lock-operator">:</span> <span class="type">SOLVER</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-governing">struct</span>
  <span class="tuareg-font-lock-governing">type</span> <span class="type">t </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
    <span class="variable-name">circuit_size</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int</span><span class="tuareg-font-lock-operator">;</span>      <span class="comment">(* Number of variables in the MNA *)</span>
    <span class="variable-name">sample_size</span>  <span class="tuareg-font-lock-operator">:</span> <span class="type">int</span><span class="tuareg-font-lock-operator">;</span>      <span class="comment">(* Total number of time domain samples *)</span>
    <span class="variable-name">harmonic_map</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">(</span><span class="type">int</span><span class="tuareg-font-lock-operator">*</span><span class="type">float</span><span class="tuareg-font-lock-operator">)</span><span class="type"> list</span><span class="tuareg-font-lock-operator">;</span>  <span class="comment">(* Map of harmonics in solution *)</span>
    <span class="variable-name">total_size</span>   <span class="tuareg-font-lock-operator">:</span> <span class="type">int</span><span class="tuareg-font-lock-operator">;</span>      <span class="comment">(* Total size of the HB matrix *)</span>
    <span class="variable-name">permut_m</span>     <span class="tuareg-font-lock-operator">:</span> <span class="type">M.matrix</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Permutation matrix *)</span>
    <span class="variable-name">permut_m</span><span class="tuareg-font-lock-operator">'</span>    <span class="tuareg-font-lock-operator">:</span> <span class="type">M.matrix</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Inverse/transpose permutation matrix *)</span>
    <span class="variable-name">y_bar</span>        <span class="tuareg-font-lock-operator">:</span> <span class="type">M.matrix</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Static HB matrix *)</span>
    <span class="variable-name">dft_m</span>        <span class="tuareg-font-lock-operator">:</span> <span class="type">M.matrix</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Block diagonal DFT matrix *)</span>
    <span class="variable-name">idft_m</span>       <span class="tuareg-font-lock-operator">:</span> <span class="type">M.matrix</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Block diagonal inverse DFT matrix *)</span>
    <span class="variable-name">b_bar</span>        <span class="tuareg-font-lock-operator">:</span> <span class="type">V.vector</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Source vector *)</span>
    <span class="variable-name">x_bar</span>        <span class="tuareg-font-lock-operator">:</span> <span class="type">V.vector</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* Results vector *)</span>
    <span class="variable-name">x_init</span>       <span class="tuareg-font-lock-operator">:</span> <span class="type">V.vector</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* DC solution to start with *)</span>
  <span class="tuareg-font-lock-operator">}</span>

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">print</span><span class="variable-name"> t </span><span class="tuareg-font-lock-operator">=</span>
    fhtml_of_matrix <span class="tuareg-font-lock-operator">~</span><span class="variable-name">file</span><span class="tuareg-font-lock-operator">:</span><span class="string">"hb_engine.xml"</span>
      <span class="tuareg-font-lock-operator">[(</span><span class="string">"y_bar"</span><span class="tuareg-font-lock-operator">,(</span>`M t.y_bar<span class="tuareg-font-lock-operator">));</span> <span class="tuareg-font-lock-operator">(</span><span class="string">"permut"</span><span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>`M t.permut_m<span class="tuareg-font-lock-operator">));</span>
       <span class="tuareg-font-lock-operator">(</span><span class="string">"b_bar"</span><span class="tuareg-font-lock-operator">,(</span>`V t.b_bar<span class="tuareg-font-lock-operator">));</span> <span class="tuareg-font-lock-operator">(</span><span class="string">"x_bar"</span><span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>`V t.x_bar<span class="tuareg-font-lock-operator">));</span>
       <span class="tuareg-font-lock-operator">(</span><span class="string">"idft"</span><span class="tuareg-font-lock-operator">,(</span>`M t.idft_m<span class="tuareg-font-lock-operator">));</span> <span class="tuareg-font-lock-operator">(</span><span class="string">"dft"</span><span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">(</span>`M t.dft_m<span class="tuareg-font-lock-operator">));]</span>
    
  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">harmonic_to_node</span><span class="variable-name"> t v_h </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">v_n </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.total_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.total_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>i <span class="tuareg-font-lock-operator">*</span> t.circuit_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">/</span> t.total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">mod</span> t.total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      v_n.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> v_h.<span class="tuareg-font-lock-operator">{</span>index<span class="tuareg-font-lock-operator">}</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    v_n

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">node_to_harmonic</span><span class="variable-name"> t v_n </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">v_h </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.total_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.total_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> t.sample_size <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">/</span> t.total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">mod</span> t.total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      v_h.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> v_n.<span class="tuareg-font-lock-operator">{</span>index<span class="tuareg-font-lock-operator">}</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    v_h

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">apply_gamma_gamma</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> t dfdx </span><span class="tuareg-font-lock-operator">=</span>
    <span class="comment">(* Now, we have to apply gamma and gamma' to the sub matrices *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">count </span><span class="tuareg-font-lock-operator">=</span> t.sample_size <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">gamma</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dft</span>.gamma<span class="tuareg-font-lock-operator">'</span> count <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">gamma </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dft</span>.gamma count <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">temp_m1 </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create count count <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">temp_m2 </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create count count <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">dfdx_bar_node </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create t.total_size t.total_size <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.circuit_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      <span class="keyword">for</span> j <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.circuit_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">offset_i </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> count <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">offset_j </span><span class="tuareg-font-lock-operator">=</span> j <span class="tuareg-font-lock-operator">*</span> count <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">for</span> k <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> count <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
          <span class="keyword">for</span> l <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> count <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
            temp_m1.<span class="tuareg-font-lock-operator">{</span>k<span class="tuareg-font-lock-operator">,</span>l<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> dfdx.<span class="tuareg-font-lock-operator">{</span>offset_i<span class="tuareg-font-lock-operator">+</span>k<span class="tuareg-font-lock-operator">,</span> offset_j<span class="tuareg-font-lock-operator">+</span>l<span class="tuareg-font-lock-operator">}</span>
          <span class="keyword">done</span>
        <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
        <span class="tuareg-font-lock-operator">(</span>gamma <span class="tuareg-font-lock-operator">|*|</span> temp_m1<span class="tuareg-font-lock-operator">)</span> temp_m2<span class="tuareg-font-lock-operator">;</span>
        <span class="tuareg-font-lock-operator">(</span>temp_m2 <span class="tuareg-font-lock-operator">|*|</span> gamma<span class="tuareg-font-lock-operator">')</span> temp_m1<span class="tuareg-font-lock-operator">;</span>
        <span class="keyword">for</span> k <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> count <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
          <span class="keyword">for</span> l <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> count <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
            dfdx_bar_node.<span class="tuareg-font-lock-operator">{</span>offset_i<span class="tuareg-font-lock-operator">+</span>k<span class="tuareg-font-lock-operator">,</span> offset_j<span class="tuareg-font-lock-operator">+</span>l<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> temp_m1.<span class="tuareg-font-lock-operator">{</span>k<span class="tuareg-font-lock-operator">,</span>l<span class="tuareg-font-lock-operator">}</span>
          <span class="keyword">done</span>
        <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    dfdx_bar_node
      
  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">solve_nonlinear</span><span class="variable-name"> solver t </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">maxiter</span><span class="tuareg-font-lock-operator">=</span>200 <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">epsabs</span><span class="tuareg-font-lock-operator">=</span>1e<span class="tuareg-font-lock-operator">-</span>9 
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">solver_method </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Gsl_multiroot</span>.<span class="type">Deriv</span>.HYBRIDSJ <span class="tuareg-font-lock-governing">in</span>  <span class="comment">(* HYBRIDSJ *)</span>
    <span class="comment">(* Create some intermediate vectors/matrices *)</span>
<span class="comment">    let x_node = V.create ~init:0. t.total_size
</span>    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">f_node </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.total_size</span>
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">f_bar_node </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.total_size </span><span class="tuareg-font-lock-governing">in</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">dfdx </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.total_size t.total_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">temp_m </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. t.circuit_size t.circuit_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">temp2_m </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create t.total_size t.total_size
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">dfdx_bar </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create t.total_size t.total_size <span class="tuareg-font-lock-governing">in</span>
    
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f_count </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">df_count </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0 <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">f_time </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0. <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">df_time </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0. <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">f</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">x</span><span class="tuareg-font-lock-operator">:</span><span class="type">x_bar </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">:</span><span class="type">y </span><span class="tuareg-font-lock-operator">=</span>
      incr f_count<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t1 </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Y*X + F(X) - B *)</span>
      <span class="comment">(* First the hard part, computation of F(X) *)</span>
      <span class="comment">(* Step 1: convert last guess to node major ordering *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_bar_node </span><span class="tuareg-font-lock-operator">=</span> harmonic_to_node t x_bar <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Step 2: perform IFFT on each node --&gt; time domain waveforms *)</span>
      <span class="tuareg-font-lock-operator">(</span>t.idft_m <span class="tuareg-font-lock-operator">|*&gt;</span> x_bar_node<span class="tuareg-font-lock-operator">)</span> x_node<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* Step 3: compute the nonlinear components *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> node_to_harmonic t x_node <span class="tuareg-font-lock-governing">in</span> <span class="comment">(* groups things correctly *)</span>
      <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.sample_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span> <span class="comment">(* for each time point *)</span> 
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">offset </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> t.circuit_size <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name">_sub </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.subvector x_node<span class="tuareg-font-lock-operator">'</span> <span class="tuareg-font-lock-operator">~</span><span class="variable-name">off</span><span class="tuareg-font-lock-operator">:</span><span class="type">offset </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">len</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.circuit_size</span>
        <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">f_node_sub </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.subvector f_node <span class="tuareg-font-lock-operator">~</span><span class="variable-name">off</span><span class="tuareg-font-lock-operator">:</span><span class="type">offset </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">len</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.circuit_size </span><span class="tuareg-font-lock-governing">in</span>
        <span class="type">Solver</span>.apply_nonlinear_functions solver <span class="tuareg-font-lock-operator">~</span><span class="variable-name">x</span><span class="tuareg-font-lock-operator">:</span><span class="type">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="type">_sub </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">y</span><span class="tuareg-font-lock-operator">:</span><span class="type">f_node_sub</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f_node </span><span class="tuareg-font-lock-operator">=</span> harmonic_to_node t f_node <span class="tuareg-font-lock-governing">in</span> <span class="comment">(* ungroup things back *)</span>
      <span class="comment">(* Step 4: perform FFT on each node *)</span>
      <span class="tuareg-font-lock-operator">(</span>t.dft_m <span class="tuareg-font-lock-operator">|*&gt;</span> f_node<span class="tuareg-font-lock-operator">)</span> f_bar_node<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* Step 5: reorder to harmonic-major form *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f_bar </span><span class="tuareg-font-lock-operator">=</span> node_to_harmonic t f_bar_node <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Final Computations *)</span>
      <span class="tuareg-font-lock-operator">(</span>t.y_bar <span class="tuareg-font-lock-operator">|*&gt;</span> x_bar<span class="tuareg-font-lock-operator">)</span> y<span class="tuareg-font-lock-operator">;</span>  <span class="comment">(* y &lt;- Y * X *)</span>
      <span class="type">V</span>.add y f_bar<span class="tuareg-font-lock-operator">;</span>          <span class="comment">(* Y &lt;- Y + F *)</span>
      <span class="type">V</span>.sub y t.b_bar<span class="tuareg-font-lock-operator">;</span>        <span class="comment">(* Y &lt;- Y - B *)</span>
      f_time <span class="tuareg-font-lock-operator">:=</span> <span class="tuareg-font-lock-operator">!</span>f_time <span class="tuareg-font-lock-operator">+.</span> <span class="tuareg-font-lock-operator">((</span><span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">-.</span> t1<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">and</span> <span class="function-name">df</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">x</span><span class="tuareg-font-lock-operator">:</span><span class="type">x_bar </span><span class="tuareg-font-lock-operator">~</span>j <span class="tuareg-font-lock-operator">=</span>
      incr df_count<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t1 </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">count </span><span class="tuareg-font-lock-operator">=</span> t.sample_size <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Y + dF(x)/dX *)</span>
      <span class="comment">(* Step 1: convert last guess to node major ordering *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_bar_node </span><span class="tuareg-font-lock-operator">=</span> harmonic_to_node t x_bar <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Step 2: perform IFFT on each node --&gt; time domain samples *)</span>
      <span class="tuareg-font-lock-operator">(</span>t.idft_m <span class="tuareg-font-lock-operator">|*&gt;</span> x_bar_node<span class="tuareg-font-lock-operator">)</span> x_node<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* Step 3: compute the partial derivatives *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> node_to_harmonic t x_node <span class="tuareg-font-lock-governing">in</span> <span class="comment">(* groups things correctly *)</span>
      <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> count <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span> <span class="comment">(* for each sample/time point *)</span>
        <span class="type">M</span>.set_zero temp_m<span class="tuareg-font-lock-operator">;</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">offset </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> t.circuit_size <span class="tuareg-font-lock-governing">in</span>
        <span class="comment">(* x_node'_sub is the vector of circuit values at time ti *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name">_sub </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.subvector x_node<span class="tuareg-font-lock-operator">'</span> <span class="tuareg-font-lock-operator">~</span><span class="variable-name">off</span><span class="tuareg-font-lock-operator">:</span><span class="type">offset </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">len</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.circuit_size </span><span class="tuareg-font-lock-governing">in</span>
        <span class="type">Solver</span>.apply_nonlinear_derivatives solver <span class="tuareg-font-lock-operator">~</span><span class="variable-name">x</span><span class="tuareg-font-lock-operator">:</span><span class="type">x_node</span><span class="tuareg-font-lock-operator">'</span><span class="type">_sub </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">j</span><span class="tuareg-font-lock-operator">:</span><span class="type">temp_m</span><span class="tuareg-font-lock-operator">;</span>
        <span class="keyword">for</span> j <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.circuit_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
          <span class="keyword">for</span> k <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.circuit_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">row </span><span class="tuareg-font-lock-operator">=</span> j <span class="tuareg-font-lock-operator">*</span> count <span class="tuareg-font-lock-operator">+</span> i
            <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">col </span><span class="tuareg-font-lock-operator">=</span> k <span class="tuareg-font-lock-operator">*</span> count <span class="tuareg-font-lock-operator">+</span> i <span class="tuareg-font-lock-governing">in</span>
            dfdx.<span class="tuareg-font-lock-operator">{</span>row<span class="tuareg-font-lock-operator">,</span>col<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> temp_m.<span class="tuareg-font-lock-operator">{</span>j<span class="tuareg-font-lock-operator">,</span>k<span class="tuareg-font-lock-operator">}</span>
          <span class="keyword">done</span>
        <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">dfdx_bar_node </span><span class="tuareg-font-lock-operator">=</span> apply_gamma_gamma<span class="tuareg-font-lock-operator">'</span> t dfdx <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-operator">(</span>t.permut_m<span class="tuareg-font-lock-operator">'</span> <span class="tuareg-font-lock-operator">|*|</span> dfdx_bar_node<span class="tuareg-font-lock-operator">)</span> temp2_m<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-operator">(</span>temp2_m <span class="tuareg-font-lock-operator">|*|</span> t.permut_m<span class="tuareg-font-lock-operator">)</span> dfdx_bar<span class="tuareg-font-lock-operator">;</span>
      <span class="type">M</span>.memcpy <span class="tuareg-font-lock-operator">~</span><span class="variable-name">src</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.y_bar </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">dst</span><span class="tuareg-font-lock-operator">:</span><span class="type">j</span><span class="tuareg-font-lock-operator">;</span>
      <span class="type">M</span>.add j dfdx_bar<span class="tuareg-font-lock-operator">;</span>
      df_time <span class="tuareg-font-lock-operator">:=</span> <span class="tuareg-font-lock-operator">!</span>df_time <span class="tuareg-font-lock-operator">+.</span> <span class="tuareg-font-lock-operator">((</span><span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">-.</span> t1<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">fdf</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">x </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">:</span><span class="type">y </span><span class="tuareg-font-lock-operator">~</span>j <span class="tuareg-font-lock-operator">=</span>
      f <span class="tuareg-font-lock-operator">~</span>x <span class="tuareg-font-lock-operator">~</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">:</span><span class="type">y</span><span class="tuareg-font-lock-operator">;</span>
      df <span class="tuareg-font-lock-operator">~</span>x <span class="tuareg-font-lock-operator">~</span>j <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">gf </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="type">Gsl_fun</span>.multi_f <span class="tuareg-font-lock-operator">=</span> f<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Gsl_fun</span>.multi_df <span class="tuareg-font-lock-operator">=</span> df<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Gsl_fun</span>.multi_fdf <span class="tuareg-font-lock-operator">=</span> fdf<span class="tuareg-font-lock-operator">;</span> <span class="tuareg-font-lock-operator">}</span>
    <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">solv </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Gsl_multiroot</span>.<span class="type">Deriv</span>.make solver_method t.total_size gf t.x_bar <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">proc</span><span class="variable-name"> iter </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">Gsl_multiroot</span>.<span class="type">Deriv</span>.iterate solv<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">status </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Gsl_multiroot</span>.<span class="type">Deriv</span>.test_residual solv epsabs <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">match</span> status <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> <span class="constant">true</span> <span class="tuareg-font-lock-operator">-&gt;</span> Converged<span class="tuareg-font-lock-operator">,</span> iter
        <span class="tuareg-font-lock-operator">|</span> <span class="constant">false</span> <span class="keyword">when</span> iter <span class="tuareg-font-lock-operator">&gt;=</span> maxiter <span class="tuareg-font-lock-operator">-&gt;</span> IterationLimitExceeded<span class="tuareg-font-lock-operator">,</span> iter
        <span class="tuareg-font-lock-operator">|</span> <span class="constant">false</span> <span class="tuareg-font-lock-operator">-&gt;</span> proc <span class="tuareg-font-lock-operator">(</span>succ iter<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">status</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> iters </span><span class="tuareg-font-lock-operator">=</span> proc 1 <span class="tuareg-font-lock-governing">in</span>
    <span class="type">Gsl_multiroot</span>.<span class="type">Deriv</span>.get_state solv <span class="tuareg-font-lock-operator">~</span><span class="variable-name">x</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.x_bar </span><span class="tuareg-font-lock-operator">();</span>
    info <span class="string">"Solver Stats: iters=%d f=%d (%g s) df=%d (%g s)"</span>
      iters <span class="tuareg-font-lock-operator">!</span>f_count <span class="tuareg-font-lock-operator">!</span>f_time <span class="tuareg-font-lock-operator">!</span>df_count <span class="tuareg-font-lock-operator">!</span>df_time<span class="tuareg-font-lock-operator">;</span>
    status

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">set_source_vector</span><span class="variable-name"> freq_mapping solver </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">b_bar </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">alpha </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">circuitSize </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Solver</span>.size solver <span class="tuareg-font-lock-governing">in</span>
    <span class="comment">(* First, lets retrieve the DC components *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">b_vec </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Solver</span>.get_b_vec solver <span class="tuareg-font-lock-operator">(</span>`DC 0.<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">V</span>.length b_vec<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      b_bar.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> b_vec.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">};</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="comment">(* Now, go through the remaining frequencies *)</span>
    <span class="type">List</span>.iter
      <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">i</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> f</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
         <span class="comment">(* Second, the REAL (cosine) terms of the AC sources *)</span>
         <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">b_vec_real </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Solver</span>.get_b_vec solver <span class="tuareg-font-lock-operator">(</span>`AC_REAL f<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
         <span class="keyword">for</span> j <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">V</span>.length b_vec<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
           b_bar.<span class="tuareg-font-lock-operator">{</span>j <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>2<span class="tuareg-font-lock-operator">*</span>i<span class="tuareg-font-lock-operator">-</span>1<span class="tuareg-font-lock-operator">)*</span>circuitSize<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> alpha <span class="tuareg-font-lock-operator">*.</span> b_vec_real.<span class="tuareg-font-lock-operator">{</span>j<span class="tuareg-font-lock-operator">};</span>
         <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
         <span class="comment">(* Finally, the IMAG (sine) terms of the AC sources *)</span>
         <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">b_vec_imag </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Solver</span>.get_b_vec solver <span class="tuareg-font-lock-operator">(</span>`AC_IMAG f<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
         <span class="keyword">for</span> j <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">V</span>.length b_vec<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
           b_bar.<span class="tuareg-font-lock-operator">{</span>j <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>2<span class="tuareg-font-lock-operator">*</span>i<span class="tuareg-font-lock-operator">)*</span>circuitSize<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> alpha <span class="tuareg-font-lock-operator">*.</span> b_vec_imag.<span class="tuareg-font-lock-operator">{</span>j<span class="tuareg-font-lock-operator">};</span>
         <span class="keyword">done</span>
      <span class="tuareg-font-lock-operator">)</span> freq_mapping
      
  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create</span><span class="variable-name"> solver </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">xinit </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">harmonic_map </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">xinit </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.of_array xinit <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">circuitSize </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Solver</span>.size solver <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">sample_size </span><span class="tuareg-font-lock-operator">=</span> 2 <span class="tuareg-font-lock-operator">*</span> <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.length harmonic_map<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">+</span> 1 <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">total_size </span><span class="tuareg-font-lock-operator">=</span> circuitSize <span class="tuareg-font-lock-operator">*</span> sample_size <span class="tuareg-font-lock-governing">in</span>
    info <span class="string">"HB Problem Size: MNA=%d harmonics=%d size=%d"</span> circuitSize
      sample_size total_size<span class="tuareg-font-lock-operator">;</span>
    <span class="comment">(* Construct the permutation and permutation transform matrices *)</span>
<span class="string">    let permut = M.create ~init:0. total_size total_size in
</span>    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">permut</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. total_size total_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> total_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>i <span class="tuareg-font-lock-operator">*</span> circuitSize<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">/</span> total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">(</span>index <span class="tuareg-font-lock-operator">mod</span> total_size<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      permut.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">,</span>index<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> 1.<span class="tuareg-font-lock-operator">;</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="type">M</span>.transpose permut<span class="tuareg-font-lock-operator">'</span> permut<span class="tuareg-font-lock-operator">;</span>
    <span class="comment">(* Ask for the y_bar matrix to be calculated *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">y_bar </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Solver</span>.get_y_bar_matrix2 solver
      <span class="tuareg-font-lock-operator">~</span><span class="variable-name">harmonics</span><span class="tuareg-font-lock-operator">:(</span><span class="type">List.length harmonic_map</span><span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">~</span><span class="variable-name">ws</span><span class="tuareg-font-lock-operator">:(</span><span class="type">List</span>.map <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">w</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> w<span class="tuareg-font-lock-operator">)</span> harmonic_map<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="comment">(* Create the source b_bar vector *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">b_bar </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. total_size </span><span class="tuareg-font-lock-governing">in</span>
    set_source_vector harmonic_map solver <span class="tuareg-font-lock-operator">~</span>b_bar <span class="tuareg-font-lock-operator">~</span><span class="variable-name">alpha</span><span class="tuareg-font-lock-operator">:</span><span class="type">1.</span><span class="tuareg-font-lock-operator">;</span>
    <span class="comment">(* Create the x_bar initial vector *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x_bar </span><span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. total_size </span><span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">V</span>.length xinit<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      x_bar.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> xinit.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="comment">(* Create the IDFTT, and DFT matrix *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">idft_m </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. total_size total_size </span>
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">dft_m </span><span class="tuareg-font-lock-operator">=</span> <span class="type">M</span>.create <span class="tuareg-font-lock-operator">~</span><span class="variable-name">init</span><span class="tuareg-font-lock-operator">:</span><span class="type">0. total_size total_size</span>
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">gamma</span><span class="tuareg-font-lock-operator">'</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dft</span>.gamma<span class="tuareg-font-lock-operator">'</span> sample_size
    <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">gamma </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dft</span>.gamma sample_size <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> circuitSize <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">shift </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> sample_size <span class="tuareg-font-lock-governing">in</span>
      blit gamma<span class="tuareg-font-lock-operator">'</span> shift shift idft_m<span class="tuareg-font-lock-operator">;</span>
      blit gamma shift shift dft_m<span class="tuareg-font-lock-operator">;</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">t </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span> circuit_size   <span class="tuareg-font-lock-operator">=</span> circuitSize<span class="tuareg-font-lock-operator">;</span>
              sample_size    <span class="tuareg-font-lock-operator">=</span> sample_size<span class="tuareg-font-lock-operator">;</span>
              harmonic_map   <span class="tuareg-font-lock-operator">=</span> harmonic_map<span class="tuareg-font-lock-operator">;</span>
              total_size     <span class="tuareg-font-lock-operator">=</span> total_size<span class="tuareg-font-lock-operator">;</span>
              permut_m       <span class="tuareg-font-lock-operator">=</span> permut<span class="tuareg-font-lock-operator">;</span>
              permut_m<span class="tuareg-font-lock-operator">'</span>      <span class="tuareg-font-lock-operator">=</span> permut<span class="tuareg-font-lock-operator">';</span>
              idft_m         <span class="tuareg-font-lock-operator">=</span> idft_m<span class="tuareg-font-lock-operator">;</span>
              dft_m          <span class="tuareg-font-lock-operator">=</span> dft_m<span class="tuareg-font-lock-operator">;</span>
              y_bar          <span class="tuareg-font-lock-operator">=</span> y_bar<span class="tuareg-font-lock-operator">;</span>
              b_bar          <span class="tuareg-font-lock-operator">=</span> b_bar<span class="tuareg-font-lock-operator">;</span>
              x_bar          <span class="tuareg-font-lock-operator">=</span> x_bar<span class="tuareg-font-lock-operator">;</span>
              x_init         <span class="tuareg-font-lock-operator">=</span> <span class="type">V</span>.copy xinit<span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="comment">(*Solver.print solver;*)</span>
    <span class="comment">(*print t;*)</span>
    t

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_single_tone</span><span class="variable-name"> solver </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">xinit </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">size </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">w </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">harmonic_map </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.init size
      <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">i </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">((</span>i<span class="tuareg-font-lock-operator">+</span>1<span class="tuareg-font-lock-operator">),</span> <span class="tuareg-font-lock-operator">(</span>w <span class="tuareg-font-lock-operator">*.</span> <span class="tuareg-font-lock-operator">(</span>float <span class="tuareg-font-lock-operator">(</span>i<span class="tuareg-font-lock-operator">+</span>1<span class="tuareg-font-lock-operator">)))))</span> <span class="tuareg-font-lock-governing">in</span>
    create solver <span class="tuareg-font-lock-operator">~</span>xinit <span class="tuareg-font-lock-operator">~</span>harmonic_map

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_two_tone</span><span class="variable-name"> solver </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">xinit </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">k1 </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">w1 </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">k2 </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">w2 </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">forward</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> reverse </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Assign3</span>.frequency_mapping <span class="tuareg-font-lock-operator">[</span>k1<span class="tuareg-font-lock-operator">;</span>k2<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-operator">[</span>w1<span class="tuareg-font-lock-operator">;</span>w2<span class="tuareg-font-lock-operator">]</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">forward </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.sort <span class="tuareg-font-lock-operator">~</span><span class="variable-name">cmp</span><span class="tuareg-font-lock-operator">:(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">p1</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">p2</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> compare p1 p2<span class="tuareg-font-lock-operator">)</span> forward <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">forward </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.filter <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">p</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> p <span class="tuareg-font-lock-operator">&lt;&gt;</span> 0<span class="tuareg-font-lock-operator">)</span> forward <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">harmonic_map </span><span class="tuareg-font-lock-operator">=</span> <span class="type">List</span>.map <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">(</span><span class="variable-name">p</span><span class="tuareg-font-lock-operator">,(</span><span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name">f</span><span class="tuareg-font-lock-operator">))</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">(</span>p<span class="tuareg-font-lock-operator">,</span>f<span class="tuareg-font-lock-operator">))</span> forward <span class="tuareg-font-lock-governing">in</span>
    create solver <span class="tuareg-font-lock-operator">~</span>xinit <span class="tuareg-font-lock-operator">~</span>harmonic_map

  <span class="comment">(*List.iter (fun (p,(ks,f)) -&gt;
    printf "p=%d --&gt; " p;
    list_iteri (fun i k -&gt; printf "k(%d)=%d " (i+1) k) ks;
    printf " f=%g\n%!" f) forward;
    List.iter (fun (f, p) -&gt; printf "f=%g --&gt; %d\n" f p) reverse;*)</span>

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">dump_results</span><span class="variable-name"> t </span><span class="tuareg-font-lock-operator">=</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.sample_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      printf <span class="string">"-- %d th Harmonic -- \n%!"</span> i<span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">for</span> j <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> t.circuit_size <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">index </span><span class="tuareg-font-lock-operator">=</span> i <span class="tuareg-font-lock-operator">*</span> t.circuit_size <span class="tuareg-font-lock-operator">+</span> j <span class="tuareg-font-lock-governing">in</span>
        printf <span class="string">"xbar(%d) = %g\n"</span> j t.x_bar.<span class="tuareg-font-lock-operator">{</span>index<span class="tuareg-font-lock-operator">}</span>
      <span class="keyword">done</span>
    <span class="keyword">done</span>

  <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ratio_threshold </span><span class="tuareg-font-lock-operator">=</span> 1e<span class="tuareg-font-lock-operator">-</span>6
  <span class="keyword">exception</span> <span class="variable-name">ConvergenceFailed</span> <span class="tuareg-font-lock-operator">of</span> string

  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">solve_with_stepping</span><span class="variable-name"> t solver </span><span class="tuareg-font-lock-operator">=</span>
    info <span class="string">"HB: starting source stepping"</span><span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">num_steps </span><span class="tuareg-font-lock-operator">=</span> 50 <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">start_time </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="comment">(* Set the x_bar initial vector *)</span>
    <span class="type">V</span>.set_zero t.x_bar<span class="tuareg-font-lock-operator">;</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">V</span>.length t.x_init<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      t.x_bar.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> t.x_init.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> num_steps <span class="keyword">do</span>
      printf <span class="string">".%!"</span><span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">alpha </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>float i<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">/.</span> <span class="tuareg-font-lock-operator">(</span>float num_steps<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      set_source_vector t.harmonic_map solver <span class="tuareg-font-lock-operator">~</span><span class="variable-name">b_bar</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.b_bar </span><span class="tuareg-font-lock-operator">~</span>alpha<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">result </span><span class="tuareg-font-lock-operator">=</span> solve_nonlinear solver t <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">match</span> result <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> Converged <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span>
        <span class="tuareg-font-lock-operator">|</span> IterationLimitExceeded <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">s </span><span class="tuareg-font-lock-operator">=</span> sprintf <span class="string">"HB source stepping failed at alpha=%g\n%!"</span> alpha <span class="tuareg-font-lock-governing">in</span>
            <span class="keyword">raise</span> <span class="tuareg-font-lock-operator">(</span>ConvergenceFailed s<span class="tuareg-font-lock-operator">)</span>
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
    printf <span class="string">"\n"</span><span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">duration </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">-.</span> start_time <span class="tuareg-font-lock-governing">in</span>
<span class="string">    info "HB: source stepping finished (steps=%d time=%g)" num_steps duration
</span>
  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">store_results</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">name t </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">r</span><span class="tuareg-font-lock-operator">:</span><span class="type">recorder</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span>
    <span class="comment">(* Check the answer
       - for each node, compare the magnitude of the highest
       component to the fundamental and see if exceeds our threshold *)</span>
    <span class="comment">(*let ratios = V.create t.circuit_size in
    let max_freq = Array.fold_left max neg_infinity t.harmonics in
    let max_freqi = Array.findi (fun x -&gt; x=max_freq) t.harmonics in*)</span>
    <span class="comment">(*for i = 0 to t.circuit_size - 1 do
      let w0_real = t.x_bar.{ t.circuit_size + i }
      and w0_imag = t.x_bar.{ (t.circuit_size * 2) + i }
</span>      <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">wn_real </span><span class="tuareg-font-lock-operator">=</span> t.x_bar.<span class="tuareg-font-lock-operator">{</span> <span class="tuareg-font-lock-operator">(</span>t.circuit_size <span class="tuareg-font-lock-operator">*</span> <span class="tuareg-font-lock-operator">(</span>t.harmonics<span class="tuareg-font-lock-operator">*</span>2 <span class="tuareg-font-lock-operator">-</span> 1<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">+</span> i <span class="tuareg-font-lock-operator">}</span>
      <span class="tuareg-font-lock-governing">and</span> <span class="variable-name">wn_imag </span><span class="tuareg-font-lock-operator">=</span> t.x_bar.<span class="tuareg-font-lock-operator">{</span> <span class="tuareg-font-lock-operator">(</span>t.circuit_size <span class="tuareg-font-lock-operator">*</span> <span class="tuareg-font-lock-operator">(</span>t.harmonics<span class="tuareg-font-lock-operator">*</span>2<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-operator">+</span> i <span class="tuareg-font-lock-operator">}</span>
      <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ratio </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Complex</span>.norm <span class="tuareg-font-lock-operator">{</span>re<span class="tuareg-font-lock-operator">=</span>wn_real<span class="tuareg-font-lock-operator">;</span> im<span class="tuareg-font-lock-operator">=</span>wn_imag<span class="tuareg-font-lock-operator">})</span> <span class="tuareg-font-lock-operator">/.</span>
        <span class="tuareg-font-lock-operator">(</span><span class="type">Complex</span>.norm <span class="tuareg-font-lock-operator">{</span>re<span class="tuareg-font-lock-operator">=</span>w0_real<span class="tuareg-font-lock-operator">;</span> im<span class="tuareg-font-lock-operator">=</span>w0_imag<span class="tuareg-font-lock-operator">})</span> <span class="tuareg-font-lock-governing">in</span>
      ratios.<span class="tuareg-font-lock-operator">{</span>i<span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-operator">&lt;-</span> <span class="keyword">match</span> classify_float ratio <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> FP_normal <span class="tuareg-font-lock-operator">-&gt;</span> ratio
        <span class="tuareg-font-lock-operator">|</span> FP_nan <span class="tuareg-font-lock-operator">-&gt;</span> 0.
        <span class="tuareg-font-lock-operator">|</span> FP_infinite <span class="tuareg-font-lock-operator">-&gt;</span> warn <span class="string">"Got an infinite ratio!!!"</span><span class="tuareg-font-lock-operator">;</span> 0.
        <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> 0.
    <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
<span class="comment">    (*let max_ratio = V.max ratios in*)
    let max_ratio = ratios.{ (V.length ratios) - 1} in
    if max_ratio &gt; ratio_threshold then begin
</span>      warn <span class="string">"Ratio of w[n] to w[1] exceeds threshold: %g &gt; %g"</span>
        max_ratio ratio_threshold<span class="tuareg-font-lock-operator">;</span>
      warn <span class="string">"You should run the simulation with more harmonics!!!"</span>
    <span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">;</span>
<span class="comment">    info "Max Ratio: %g" (V.max ratios);*)</span>
    <span class="comment">(* record the answer *)</span>
    r<span class="tuareg-font-lock-operator">#</span>append_complex name 0. <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">j </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">{</span>re<span class="tuareg-font-lock-operator">=</span>t.x_bar.<span class="tuareg-font-lock-operator">{</span>j<span class="tuareg-font-lock-operator">};</span> im<span class="tuareg-font-lock-operator">=</span>0.<span class="tuareg-font-lock-operator">});</span>
    <span class="keyword">for</span> i <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">to</span> <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.length t.harmonic_map<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-</span> 1 <span class="keyword">do</span>
      r<span class="tuareg-font-lock-operator">#</span>append_complex name <span class="tuareg-font-lock-operator">(</span><span class="type">List</span>.assoc <span class="tuareg-font-lock-operator">(</span>i<span class="tuareg-font-lock-operator">+</span>1<span class="tuareg-font-lock-operator">)</span> t.harmonic_map<span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">j </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-operator">{</span>re<span class="tuareg-font-lock-operator">=</span>t.x_bar.<span class="tuareg-font-lock-operator">{(</span>2<span class="tuareg-font-lock-operator">*</span>i<span class="tuareg-font-lock-operator">+</span>1<span class="tuareg-font-lock-operator">)*</span>t.circuit_size <span class="tuareg-font-lock-operator">+</span> j<span class="tuareg-font-lock-operator">};</span>
           im<span class="tuareg-font-lock-operator">=</span>t.x_bar.<span class="tuareg-font-lock-operator">{(</span>2<span class="tuareg-font-lock-operator">*</span>i<span class="tuareg-font-lock-operator">+</span>2<span class="tuareg-font-lock-operator">)*</span>t.circuit_size <span class="tuareg-font-lock-operator">+</span> j<span class="tuareg-font-lock-operator">}})</span>
    <span class="keyword">done</span>
      
  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">solve</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">name t solver r </span><span class="tuareg-font-lock-operator">=</span>
    info <span class="string">"Performing HB analysis (%s)"</span> name<span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">start_time </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">result </span><span class="tuareg-font-lock-operator">=</span> solve_nonlinear solver t <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">duration </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">-.</span> start_time <span class="tuareg-font-lock-governing">in</span>
    <span class="keyword">match</span> result <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">|</span> Converged <span class="tuareg-font-lock-operator">-&gt;</span>
          info <span class="string">"HB analysis complete (WALL time=%g s). Storing results."</span> duration<span class="tuareg-font-lock-operator">;</span>
          store_results <span class="tuareg-font-lock-operator">~</span>name t r
      <span class="tuareg-font-lock-operator">|</span> IterationLimitExceeded <span class="tuareg-font-lock-operator">-&gt;</span>
          warn <span class="string">"HB analysis: failed to converge (WALL time=%g s)"</span> duration<span class="tuareg-font-lock-operator">;</span>
          info <span class="string">"Starting source stepping algorithm"</span><span class="tuareg-font-lock-operator">;</span>
          solve_with_stepping t solver<span class="tuareg-font-lock-operator">;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">total_duration </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Unix</span>.gettimeofday <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">-.</span> start_time <span class="tuareg-font-lock-governing">in</span>
          info <span class="string">"HB analysis: PROBLEM_SIZE=%d TOTAL WALL TIME=%g s"</span>
            t.total_size total_duration<span class="tuareg-font-lock-operator">;</span>
          store_results <span class="tuareg-font-lock-operator">~</span>name t r
<span class="string">
</span>  <span class="tuareg-font-lock-governing">let</span> <span class="function-name">solve_linear</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">name t r </span><span class="tuareg-font-lock-operator">=</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">mna_matrix </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Gsl_matrix</span>.copy t.y_bar <span class="tuareg-font-lock-governing">in</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">answer </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Gsl_linalg</span>.solve_LU <span class="tuareg-font-lock-operator">(</span>`M mna_matrix<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>`V t.b_bar<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
    <span class="type">V</span>.memcpy <span class="tuareg-font-lock-operator">~</span><span class="variable-name">src</span><span class="tuareg-font-lock-operator">:(</span><span class="type">V.of_array answer</span><span class="tuareg-font-lock-operator">)</span><span class="type"> </span><span class="tuareg-font-lock-operator">~</span><span class="variable-name">dst</span><span class="tuareg-font-lock-operator">:</span><span class="type">t.x_bar</span><span class="tuareg-font-lock-operator">;</span>
    warn <span class="string">"results are not being stored"</span><span class="tuareg-font-lock-operator">;</span>
    dump_results t
  
<span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">;;</span></pre>

